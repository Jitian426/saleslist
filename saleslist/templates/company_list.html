{% load humanize %}
{% load url_params %}
<!DOCTYPE html>
<html lang="ja">
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼šç¤¾ãƒªã‚¹ãƒˆ</title>
    <style>
        table {
            width: 100%;
            font-size: 12px;
            border-collapse: collapse;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border: none;
        }
        thead {
            border-bottom: 2px solid #ccc;
        }
        tbody tr {
            border-bottom: 1px solid #e0e0e0;
        }
        tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tbody tr:hover {
            background-color: #f1f1f1;
        }
        .address {
            max-width: 300px;
            word-wrap: break-word;
            white-space: normal;
        }
    </style>
</head>
<body>
<!-- â–¼ KPIãƒšãƒ¼ã‚¸ãƒªãƒ³ã‚¯ -->
<div class="d-flex justify-content-end mb-3">
  <a href="{% url 'saleslist:daily_kpi' %}" class="btn btn-outline-primary btn-sm">
    ğŸ“Š æ—¥æ¬¡KPIï¼ˆæ‹…å½“è€…åˆ¥ï¼‰ã‚’è¦‹ã‚‹
  </a>
</div>
<!-- â–² KPIãƒšãƒ¼ã‚¸ãƒªãƒ³ã‚¯ -->

<div class="d-flex justify-content-between align-items-center px-3 py-1" style="border-bottom: 1px solid #ccc;">
  <h2 class="mb-1" style="font-size: 24px;">Saleslist</h2>
  <div class="d-flex align-items-center" style="gap: 10px; font-size: 12px;">
    {% if user.is_superuser or user.username == 'ryuji' %}
      <a href="{% url 'saleslist:upload_csv' %}" class="btn btn-outline-primary btn-sm" style="font-size: 12px; padding: 2px 6px;">CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</a>
      <a href="{% url 'saleslist:export_companies_csv' %}" class="btn btn-outline-primary btn-sm">ä¼šç¤¾æƒ…å ±CSVå‡ºåŠ›</a>
      <a href="{% url 'saleslist:export_salesactivities_csv' %}" class="btn btn-outline-secondary btn-sm">å–¶æ¥­å±¥æ­´CSVå‡ºåŠ›</a>
    {% endif %}
    {% if user.is_authenticated %}
      <a href="{% url 'saleslist:dashboard' %}">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>  /  
      {% if can_view_user_info %}
        <a href="{% url 'saleslist:user_list' %}">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆ</a>  /  
      {% endif %}
      <a href="{% url 'saleslist:password_reset' %}">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</a>  /  
      <form id="logout-form" action="{% url 'saleslist:logout' %}" method="post" style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="btn btn-link p-0" style="font-size: 0.9rem;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </form>
    {% endif %}
  </div>
</div>

{% if user.is_superuser or user.username == 'ryuji' %}
  <form method="get" action="{% url 'saleslist:confirm_delete_filtered_companies' %}" class="px-4 mt-2">
    {% for key, value in request.GET.items %}
      <input type="hidden" name="{{ key }}" value="{{ value }}">
    {% endfor %}
    <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('ã“ã®æ¤œç´¢æ¡ä»¶ã®ä¼šç¤¾ä¸€è¦§ã‚’ç¢ºèªãƒ»å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')">
      ã“ã®æ¤œç´¢çµæœã®ä¸€æ‹¬å‰Šé™¤ã‚’ç¢ºèª
    </button>
  </form>
{% endif %}

<div class="container-fluid px-4">
  <form method="GET" action="{% url 'saleslist:company_list' %}" class="mb-3">
    <div class="row g-2 align-items-end">
        <label class="form-label mb-0 small">æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
        <div class="col-sm-2"><input type="text" class="form-control form-control-sm" name="query" placeholder="åº—èˆ—å" value="{{ query }}"></div>
        <div class="col-sm-2"><input type="text" class="form-control form-control-sm" name="phone" placeholder="é›»è©±ç•ªå·" value="{{ phone }}"></div>
        <div class="col-sm-2"><input type="text" class="form-control form-control-sm" name="address" placeholder="ä½æ‰€" value="{{ address }}"></div>
        <div class="col-sm-2"><input type="text" class="form-control form-control-sm" name="corporation_name" placeholder="æ³•äººå" value="{{ corporation_name }}"></div>
        <div class="col-sm-2"><input type="text" class="form-control form-control-sm" name="industry" placeholder="å¤§æ¥­ç¨®" value="{{ industry }}"></div>
        <div class="col-sm-2"><input type="text" class="form-control form-control-sm" name="sub_industry" placeholder="å°æ¥­ç¨®" value="{{ sub_industry }}"></div>
        <div class="col-sm-2"><input type="text" class="form-control form-control-sm" name="license_number" placeholder="è¨±å¯ç•ªå·ãƒ»ãƒªã‚¹ãƒˆå" value="{{ license_number }}"></div>

        <div class="col-sm-2">
          <label class="form-label mb-0 small">æ´»å‹•æ—¥ (é–‹å§‹)</label>
          <input type="date" class="form-control form-control-sm" name="start_date" value="{{ start_date }}">
        </div>
        <div class="col-sm-2">
          <label class="form-label mb-0 small">æ´»å‹•æ—¥ (çµ‚äº†)</label>
          <input type="date" class="form-control form-control-sm" name="end_date" value="{{ end_date }}">
        </div>
        <div class="col-sm-2">
          <label class="form-label mb-0 small">å–¶æ¥­çµæœ</label>
          <select name="result" class="form-select form-select-sm">
            <option value="">ã™ã¹ã¦</option>
            {% for res in results %}
              <option value="{{ res }}" {% if result == res %}selected{% endif %}>{{ res }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-sm-2">
          <label class="form-label mb-0 small">å–¶æ¥­æ‹…å½“è€…</label>
          <select name="sales_person" class="form-select form-select-sm">
            <option value="">ã™ã¹ã¦</option>
            {% for activity in sales_persons %}
              <option value="{{ activity.sales_person }}" {% if sales_person == activity.sales_person %}selected{% endif %}>
                {{ activity.sales_person }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-sm-2">
          <label class="form-label mb-0 small">æ¬¡å›äºˆå®š (é–‹å§‹)</label>
          <input type="date" class="form-control form-control-sm" name="next_action_start" value="{{ next_action_start }}">
        </div>
        <div class="col-sm-2">
          <label class="form-label mb-0 small">æ¬¡å›äºˆå®š (çµ‚äº†)</label>
          <input type="date" class="form-control form-control-sm" name="next_action_end" value="{{ next_action_end }}">
        </div>
        <div class="col-sm-2">
          <label class="form-label mb-0 small">é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
          <input type="text" class="form-control form-control-sm" name="exclude_query" placeholder="é™¤å¤–ãƒ¯ãƒ¼ãƒ‰" value="{{ exclude_query }}">
        </div>
  
        <div class="col-sm-2">
          <button type="submit" class="btn btn-sm btn-primary w-100">æ¤œç´¢</button>
        </div>
        <div class="col-sm-2">
          <a href="{% url 'saleslist:company_list' %}" class="btn btn-sm btn-outline-secondary w-100">ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆ</a>
        </div>

    </div>
  </form>
</div>

<!-- âœ… å¯¾è±¡ãƒ¬ã‚³ãƒ¼ãƒ‰ãƒ»ç·ãƒ¬ã‚³ãƒ¼ãƒ‰ä»¶æ•° -->
<div class="d-flex justify-content-start align-items-center mt-2 mb-2" style="font-size: 11px; color: #555;">
  å¯¾è±¡ãƒ¬ã‚³ãƒ¼ãƒ‰: {{ page_obj.paginator.count|intcomma }}ã€€
  ç·ãƒ¬ã‚³ãƒ¼ãƒ‰: {{ total_records|intcomma }}
</div>

<!-- âœ… ã‚½ãƒ¼ãƒˆè§£é™¤ï¼‹æ–°è¦ç™»éŒ²ãƒœã‚¿ãƒ³ -->
<div class="d-flex justify-content-end mt-2 mb-0">
    <a href="?sort=id&order=asc" class="btn btn-outline-secondary btn-sm" style="font-size: 11px; padding: 2px 6px;">ã‚½ãƒ¼ãƒˆè§£é™¤</a>
    <a href="{% url 'saleslist:company_create' %}" class="btn btn-primary btn-sm ms-3" style="font-size: 11px; padding: 2px 8px;">ä¼šç¤¾æ–°è¦ç™»éŒ²</a>
</div>

<div class="table-responsive">
  <table class="table table-striped table-hover align-middle">
    <thead class="table-light">
      <tr>
        <th>
          {% url_params request.GET sort="name" order=next_order|default:"asc" as query_name %}
          <a href="?{{ query_name }}">
            åº—èˆ—å {% if sort_column == "name" %}{% if sort_order == "asc" %}â–²{% else %}â–¼{% endif %}{% endif %}
          </a>
        </th>
        <th>
          {% url_params request.GET sort="phone" order=next_order|default:"asc" as query_phone %}
          <a href="?{{ query_phone }}">
            åº—èˆ—é›»è©±ç•ªå· {% if sort_column == "phone" %}{% if sort_order == "asc" %}â–²{% else %}â–¼{% endif %}{% endif %}
          </a>
        </th>
        <th>
          {% url_params request.GET sort="mobile_phone" order=next_order as query_mobile %}
          <a href="?{{ query_mobile }}">
            æºå¸¯ç•ªå· {% if sort_column == "mobile_phone" %}{% if sort_order == "asc" %}â–²{% else %}â–¼{% endif %}{% endif %}
          </a>
        </th>
        <th class="address">
          {% url_params request.GET sort="address" order=next_order as query_address %}
          <a href="?{{ query_address }}">
            åº—èˆ—ä½æ‰€ {% if sort_column == "address" %}{% if sort_order == "asc" %}â–²{% else %}â–¼{% endif %}{% endif %}
          </a>
        </th>
        <th>
          {% url_params request.GET sort="corporation_name" order=next_order as query_corp %}
          <a href="?{{ query_corp }}">
            æ³•äººå {% if sort_column == "corporation_name" %}{% if sort_order == "asc" %}â–²{% else %}â–¼{% endif %}{% endif %}
          </a>
        </th>
        <th>
          {% url_params request.GET sort="established_date" order=next_order|default:"asc" as query_established_date %}
          <a href="?{{ query_established_date }}">
            é–‹æ¥­æ—¥ {% if sort_column == "established_date" %}{% if sort_order == "asc" %}â–²{% else %}â–¼{% endif %}{% endif %}
          </a>
        </th>

        <th>
          {% url_params request.GET sort="license_number" order=next_order as query_license_number %}
          <a href="?{{ query_license_number }}">
            è¨±å¯ç•ªå· {% if sort_column == "license_number" %}{% if sort_order == "asc" %}â–²{% else %}â–¼{% endif %}{% endif %}
          </a>
        </th>
        <th>
          {% url_params request.GET sort="industry" order=next_order as query_industry %}
          <a href="?{{ query_industry }}">
            å¤§æ¥­ç¨® {% if sort_column == "industry" %}{% if sort_order == "asc" %}â–²{% else %}â–¼{% endif %}{% endif %}
          </a>
        </th>
        <th>
          {% url_params request.GET sort="sub_industry" order=next_order as query_sub_industry %}
          <a href="?{{ query_sub_industry }}">
            å°æ¥­ç¨® {% if sort_column == "sub_industry" %}{% if sort_order == "asc" %}â–²{% else %}â–¼{% endif %}{% endif %}
          </a>
        </th>

        <th>
          {% url_params request.GET sort="latest_activity_date" order=next_order as query_act %}
          <a href="?{{ query_act }}">
            æ´»å‹•æ—¥ {% if sort_column == "latest_activity_date" %}{% if sort_order == "asc" %}â–²{% else %}â–¼{% endif %}{% endif %}
          </a>
        </th>
        <th>
          {% url_params request.GET sort="latest_sales_person" order=next_order as query_person %}
          <a href="?{{ query_person }}">
            å–¶æ¥­æ‹…å½“è€… {% if sort_column == "latest_sales_person" %}{% if sort_order == "asc" %}â–²{% else %}â–¼{% endif %}{% endif %}
          </a>
        </th>
        <th>
          {% url_params request.GET sort="latest_result" order=next_order as query_result %}
          <a href="?{{ query_result }}">
            å–¶æ¥­çµæœ {% if sort_column == "latest_result" %}{% if sort_order == "asc" %}â–²{% else %}â–¼{% endif %}{% endif %}
          </a>
        </th>
        <th>
          {% url_params request.GET sort="latest_next_action_date" order=next_order as query_next %}
          <a href="?{{ query_next }}">
            æ¬¡å›å–¶æ¥­äºˆå®šæ—¥ {% if sort_column == "latest_next_action_date" %}{% if sort_order == "asc" %}â–²{% else %}â–¼{% endif %}{% endif %}
          </a>
        </th>
      </tr>
    </thead>    
    
    <tbody>
      {% for company in companies %}
        <tr>
          <td>
            {% url_params request.GET sort=sort_column order=sort_order as full_query %}
            <a href="{% url 'saleslist:company_detail' company.id %}?{{ full_query }}">
              {{ company.name }}
            </a>
          </td>
          <td>{{ company.phone }}</td>
          <td>{{ company.mobile_phone }}</td>
          <td class="address">{{ company.address }}</td>
          <td>{{ company.corporation_name }}</td>
          <td>{{ company.established_date|date:"Y/m/d" }}</td>
          <td>{{ company.license_number }}</td>
          <td>{{ company.industry }}</td>
          <td>{{ company.sub_industry }}</td>
          <td>{{ company.latest_activity_date|date:"Y/m/d H:i" }}</td>
          <td>{{ company.latest_sales_person|default_if_none:"" }}</td>
          <td>{{ company.latest_result|default_if_none:"" }}</td>
          <td>{{ company.latest_next_action_date|date:"Y/m/d H:i" }}</td>
        </tr>
      {% empty %}
        <tr><td colspan="11">è©²å½“ã™ã‚‹ä¼šç¤¾ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- âœ… ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³UI -->
<div class="d-flex justify-content-center my-3">
    <nav>
      <ul class="pagination pagination-sm">
        {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode|cut:'page='|cut:'&page=' }}">å‰ã¸</a>
          </li>
        {% endif %}
  
        {# âœ… ãƒšãƒ¼ã‚¸ç•ªå·ãƒªãƒ³ã‚¯ã‚’å‡ºåŠ›ï¼ˆå‰å¾Œ2ãƒšãƒ¼ã‚¸ï¼‹ç¾åœ¨ï¼‰ #}
        {% for num in page_obj.paginator.page_range %}
          {% if num >= page_obj.number|add:'-2' and num <= page_obj.number|add:'2' %}
            {% if num == page_obj.number %}
              <li class="page-item active">
                <span class="page-link">{{ num }}</span>
              </li>
            {% else %}
              <li class="page-item">
                <a class="page-link" href="?page={{ num }}&{{ request.GET.urlencode|cut:'page='|cut:'&page=' }}">{{ num }}</a>
              </li>
            {% endif %}
          {% endif %}
        {% endfor %}
  
        {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode|cut:'page='|cut:'&page=' }}">æ¬¡ã¸</a>
          </li>
        {% endif %}
      </ul>
    </nav>
</div>

</body>
</html>
