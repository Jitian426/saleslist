{% load humanize %}
<!DOCTYPE html>
<html lang="ja">
<head>
    <!-- Bootstrap 5 ã®CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼šç¤¾ãƒªã‚¹ãƒˆ</title>
    <style>
        table {
            width: 100%;
            font-size: 12px;
            border-collapse: collapse;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border: none; /* âœ… æ ç·šæ’¤å»ƒ */
        }
        thead {
            border-bottom: 2px solid #ccc; /* âœ… ãƒ˜ãƒƒãƒ€ãƒ¼ä¸‹ã«ã‚°ãƒ¬ãƒ¼ã®ç·š */
        }
        tbody tr {
            border-bottom: 1px solid #e0e0e0; /* âœ… å„è¡Œã®ä¸‹ã«è–„ã„ç·š */
        }
        tbody tr:nth-child(even) {
            background-color: #f9f9f9; /* âœ… å¶æ•°è¡Œã®èƒŒæ™¯è‰² */
        }
        tbody tr:hover {
            background-color: #f1f1f1; /* âœ… ãƒ›ãƒãƒ¼æ™‚ã®èƒŒæ™¯è‰² */
        }
        body {
            font-size: 12px;
        }
        th {
            background-color: #f2f2f2;
        }
        .address {
            max-width: 300px;  /* âœ… åº—èˆ—ä½æ‰€ã¯é•·ã‚ã« */
            word-wrap: break-word;
            white-space: normal;
        }
    </style>
</head>
<body>
    <!-- âœ… ãƒšãƒ¼ã‚¸ä¸Šéƒ¨ï¼šã‚¿ã‚¤ãƒˆãƒ«ï¼‹å³ä¸Šãƒªãƒ³ã‚¯ç¾¤ï¼ˆæ¨ªä¸¦ã³ï¼‰ -->
    <div class="d-flex justify-content-between align-items-center px-3 py-1" style="border-bottom: 1px solid #ccc;">

    <h2 class="mb-1" style="font-size: 24px;">Saleslist</h2>
    
    <div class="d-flex align-items-center" style="gap: 10px; font-size: 12px;">
        {% if user.is_superuser or user.username == 'ryuji' %}
        <a href="{% url 'saleslist:upload_csv' %}"
        class="btn btn-outline-primary btn-sm"
        style="font-size: 12px; padding: 2px 6px;">
        CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
     </a>
     <a href="{% url 'saleslist:export_companies_csv' %}"
        class="btn btn-outline-success btn-sm"
        style="font-size: 12px; padding: 2px 6px;">
        CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
     </a>
        {% endif %}
        {% if user.is_authenticated %}
            <a href="{% url 'saleslist:dashboard' %}">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a> /
            <a href="{% url 'saleslist:password_reset' %}">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</a> /
            <form id="logout-form" action="{% url 'saleslist:logout' %}" method="post" style="display: inline;">
                {% csrf_token %}
                <button type="submit" style="all: unset; color: blue; cursor: pointer;">
                    ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                </button>
            </form>
        {% endif %}
    </div>
</div>

    <div class="container-fluid px-4">
        <form method="GET" action="{% url 'saleslist:company_list' %}" class="mb-3">
            <div class="row g-2 align-items-end">
              <div class="col-sm-2">
                <input type="text" class="form-control form-control-sm" name="query" placeholder="åº—èˆ—å" value="{{ query }}">
              </div>
              <div class="col-sm-2">
                <input type="text" class="form-control form-control-sm" name="phone" placeholder="é›»è©±ç•ªå·" value="{{ phone }}">
              </div>
              <!-- âœ… ãƒ†ã‚¹ãƒˆæŒ¿å…¥ é™¤å¤–æ¤œç´¢æ©Ÿèƒ½ -->
              <div class="col-sm-2">
                <input type="text" class="form-control form-control-sm" name="exclude_query" placeholder="é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰" value="{{ exclude_query }}">
              </div>
              
              <div class="col-sm-2">
                <input type="text" class="form-control form-control-sm" name="address" placeholder="ä½æ‰€" value="{{ address }}">
              </div>
              <div class="col-sm-2">
                <input type="text" class="form-control form-control-sm" name="corporation_name" placeholder="æ³•äººå" value="{{ corporation_name }}">
              </div>
              <div class="col-sm-2">
                <input type="text" class="form-control form-control-sm" name="industry" placeholder="å¤§æ¥­ç¨®" value="{{ industry }}">
              </div>
              <div class="col-sm-2">
                <input type="text" class="form-control form-control-sm" name="sub_industry" placeholder="å°æ¥­ç¨®" value="{{ sub_industry }}">
              </div>
          
              <!-- æ”¹è¡Œã—ã¦2æ®µç›® -->
              <div class="col-sm-2">
                <label class="form-label mb-0 small">æ´»å‹•æ—¥ (é–‹å§‹)</label>
                <input type="date" class="form-control form-control-sm" name="start_date" value="{{ start_date }}">
              </div>
              <div class="col-sm-2">
                <label class="form-label mb-0 small">æ´»å‹•æ—¥ (çµ‚äº†)</label>
                <input type="date" class="form-control form-control-sm" name="end_date" value="{{ end_date }}">
              </div>
              <div class="col-sm-2">
                <label class="form-label mb-0 small">å–¶æ¥­æ‹…å½“è€…</label>
                <select name="sales_person" class="form-select form-select-sm">
                  <option value="">ã™ã¹ã¦</option>
                  {% for activity in sales_persons %}
                    <option value="{{ activity.sales_person }}" {% if sales_person == activity.sales_person %}selected{% endif %}>
                      {{ activity.sales_person }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-sm-2">
                <label class="form-label mb-0 small">å–¶æ¥­çµæœ</label>
                <select name="result" class="form-select form-select-sm">
                  <option value="">ã™ã¹ã¦</option>
                  {% for res in results %}
                    <option value="{{ res }}" {% if result == res %}selected{% endif %}>{{ res }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-sm-2">
                <label class="form-label mb-0 small">æ¬¡å›äºˆå®š (é–‹å§‹)</label>
                <input type="date" class="form-control form-control-sm" name="next_action_start" value="{{ next_action_start }}">
              </div>
              <div class="col-sm-2">
                <label class="form-label mb-0 small">æ¬¡å›äºˆå®š (çµ‚äº†)</label>
                <input type="date" class="form-control form-control-sm" name="next_action_end" value="{{ next_action_end }}">
              </div>
          
              <!-- ãƒœã‚¿ãƒ³ -->
              <div class="col-sm-2">
                <button type="submit" class="btn btn-sm btn-primary w-100">æ¤œç´¢</button>
              </div>
              <div class="col-sm-2">
                <a href="{% url 'saleslist:company_list' %}" class="btn btn-sm btn-outline-secondary w-100">ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆ</a>
              </div>
            </div>
        </form>
    </div>

<!-- âœ… å¯¾è±¡ãƒ¬ã‚³ãƒ¼ãƒ‰ãƒ»ç·ãƒ¬ã‚³ãƒ¼ãƒ‰ä»¶æ•°ï¼ˆå³ä¸‹ã«å°ã•ãï¼‰ -->
<div class="d-flex justify-content-start align-items-center mt-2 mb-2" style="font-size: 11px; color: #555;">
  å¯¾è±¡ãƒ¬ã‚³ãƒ¼ãƒ‰: {{ page_obj.paginator.count|intcomma }}ã€€
  ç·ãƒ¬ã‚³ãƒ¼ãƒ‰: {{ total_records|intcomma }}
</div>

    <!-- ğŸ”½ ãƒ†ãƒ¼ãƒ–ãƒ«é–‹å§‹å‰ã«è¿½åŠ  -->
<div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
        ...
    </table>
</div>

<!-- âœ… ã‚½ãƒ¼ãƒˆè§£é™¤ï¼‹æ–°è¦ç™»éŒ²ãƒœã‚¿ãƒ³ -->
<div class="d-flex justify-content-end mt-2 mb-0">
  <a href="?sort=id&order=asc" class="btn btn-outline-secondary btn-sm" style="font-size: 11px; padding: 2px 6px;">
      ã‚½ãƒ¼ãƒˆè§£é™¤
  </a>
  <a href="{% url 'saleslist:company_create' %}" class="btn btn-primary btn-sm ms-3" style="font-size: 11px; padding: 2px 8px;">
      ä¼šç¤¾æ–°è¦ç™»éŒ²
  </a>
</div>

    <table class="table table-striped table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th>
                  <a href="?sort=name&order={% if sort_column == 'name' and sort_order == 'asc' %}desc{% else %}asc{% endif %}&{{ request.GET.urlencode|safe }}">
                        åº—èˆ—å {% if sort_column == "name" %}{% if sort_order == "asc" %}â–²{% else %}â–¼{% endif %}{% endif %}
                    </a>
                </th>
                <th>
                  <a href="?sort=name&order={% if sort_column == 'phone' and sort_order == 'asc' %}desc{% else %}asc{% endif %}&{{ request.GET.urlencode|safe }}">
                        åº—èˆ—é›»è©±ç•ªå· {% if sort_column == "phone" %}{% if sort_order == "asc" %}â–²{% else %}â–¼{% endif %}{% endif %}
                    </a>
                </th>
                <th>
                  <a href="?sort=name&order={% if sort_column == 'mobile_phone' and sort_order == 'asc' %}desc{% else %}asc{% endif %}&{{ request.GET.urlencode|safe }}">
                        æºå¸¯ç•ªå· {% if sort_column == "mobile_phone" %}{% if sort_order == "asc" %}â–²{% else %}â–¼{% endif %}{% endif %}
                    </a>
                </th>
                <th class="address">
                  <a href="?sort=name&order={% if sort_column == 'address' and sort_order == 'asc' %}desc{% else %}asc{% endif %}&{{ request.GET.urlencode|safe }}">
                        åº—èˆ—ä½æ‰€ {% if sort_column == "address" %}{% if sort_order == "asc" %}â–²{% else %}â–¼{% endif %}{% endif %}
                    </a>
                </th>
                <th>
                  <a href="?sort=name&order={% if sort_column == 'corporation_name' and sort_order == 'asc' %}desc{% else %}asc{% endif %}&{{ request.GET.urlencode|safe }}">
                        æ³•äººå {% if sort_column == "corporation_name" %}{% if sort_order == "asc" %}â–²{% else %}â–¼{% endif %}{% endif %}
                    </a>
                </th>
                <th>
                  <a href="?sort=name&order={% if sort_column == 'established_date' and sort_order == 'asc' %}desc{% else %}asc{% endif %}&{{ request.GET.urlencode|safe }}">
                        é–‹æ¥­æ—¥ {% if sort_column == "established_date" %}{% if sort_order == "asc" %}â–²{% else %}â–¼{% endif %}{% endif %}
                    </a>
                </th>
                <th>
                  <a href="?sort=name&order={% if sort_column == 'license_number' and sort_order == 'asc' %}desc{% else %}asc{% endif %}&{{ request.GET.urlencode|safe }}">
                        è¨±å¯ç•ªå· {% if sort_column == "license_number" %}{% if sort_order == "asc" %}â–²{% else %}â–¼{% endif %}{% endif %}
                    </a>
                </th>
                <th>
                  <a href="?sort=name&order={% if sort_column == 'latest_activity_date' and sort_order == 'asc' %}desc{% else %}asc{% endif %}&{{ request.GET.urlencode|safe }}">
                      æ´»å‹•æ—¥ {% if sort_column == "latest_activity_date" %}{% if sort_order == "asc" %}â–²{% else %}â–¼{% endif %}{% endif %}
                    </a>
                  </th>
                  <th>
                    <a href="?sort=name&order={% if sort_column == 'latest_sales_person' and sort_order == 'asc' %}desc{% else %}asc{% endif %}&{{ request.GET.urlencode|safe }}">
                      å–¶æ¥­æ‹…å½“è€… {% if sort_column == "latest_sales_person" %}{% if sort_order == "asc" %}â–²{% else %}â–¼{% endif %}{% endif %}
                    </a>
                  </th>
                  <th>
                    <a href="?sort=name&order={% if sort_column == 'latest_result' and sort_order == 'asc' %}desc{% else %}asc{% endif %}&{{ request.GET.urlencode|safe }}">
                      å–¶æ¥­çµæœ {% if sort_column == "latest_result" %}{% if sort_order == "asc" %}â–²{% else %}â–¼{% endif %}{% endif %}
                    </a>
                  </th>
                  <th>
                    <a href="?sort=name&order={% if sort_column == 'latest_next_action_date' and sort_order == 'asc' %}desc{% else %}asc{% endif %}&{{ request.GET.urlencode|safe }}">
                      æ¬¡å›å–¶æ¥­äºˆå®šæ—¥ {% if sort_column == "latest_next_action_date" %}{% if sort_order == "asc" %}â–²{% else %}â–¼{% endif %}{% endif %}
                    </a>
                  </th>
                  
            </tr>
        </thead>
        <tbody>
        {% for company in companies %}
        
            <tr>
                <td><a href="{% url 'saleslist:company_detail' company.id %}">{{ company.name }}</a></td>
                <td>{{ company.phone }}</td>
                <td>{{ company.mobile_phone }}</td>
                <td class="address">{{ company.address }}</td>
                <td>{{ company.corporation_name }}</td>
                <td>{{ company.established_date|date:"Y/m/d" }}</td>
                <td>{{ company.license_number }}</td>
    
                <td>{{ company.latest_activity_date|date:"Y/m/d H:i" }}</td>
                <td>{{ company.latest_sales_person|default_if_none:"" }}</td>
                <td>{{ company.latest_result|default_if_none:"" }}</td>
                <td>{{ company.latest_next_action_date|date:"Y/m/d H:i" }}</td>
                
            </tr>
            
        {% empty %}
            <tr>
                <td colspan="9">è©²å½“ã™ã‚‹ä¼šç¤¾ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    
<!-- âœ… æ”¹è‰¯ç‰ˆãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
<div class="d-flex justify-content-center my-3">
  <nav>
    <ul class="pagination pagination-sm">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode|safe|cut:'page='|cut:'&page=' }}">å‰ã¸</a>
        </li>
      {% endif %}

      {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
          <li class="page-item active"><span class="page-link">{{ num }}</span></li>
        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
          <li class="page-item">
            <a class="page-link" href="?page={{ num }}&{{ request.GET.urlencode|safe|cut:'page='|cut:'&page=' }}">{{ num }}</a>
          </li>
        {% endif %}
      {% endfor %}

      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode|safe|cut:'page='|cut:'&page=' }}">æ¬¡ã¸</a>
        </li>
      {% endif %}
    </ul>
  </nav>
</div>


</body>
</html>
