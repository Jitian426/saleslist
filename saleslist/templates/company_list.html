<!DOCTYPE html>
<html lang="ja">
<head>
    <!-- Bootstrap 5 のCDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>会社リスト</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;  /* ✅ 文字サイズを小さくして全情報が収まるように */
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
            word-wrap: break-word;
        }
        th {
            background-color: #f2f2f2;
        }
        .address {
            max-width: 300px;  /* ✅ 店舗住所は長めに */
            word-wrap: break-word;
            white-space: normal;
        }
    </style>
</head>
<body>
    <h2>会社リスト</h2>
    <form id="logout-form" action="{% url 'saleslist:logout' %}" method="post">
        {% csrf_token %}
        <button type="submit">ログアウト</button>
    </form>

    <!-- 🔹 検索フォーム -->
<form method="GET">
    <input type="text" name="query" placeholder="店舗名" value="{{ query }}">
    <input type="text" name="phone" placeholder="電話番号" value="{{ phone }}">
    <input type="text" name="address" placeholder="住所" value="{{ address }}">
    <input type="text" name="corporation_name" placeholder="法人名" value="{{ corporation_name }}">
    <input type="text" name="corporation_phone" placeholder="法人電話番号" value="{{ corporation_phone }}">
    <input type="text" name="industry" placeholder="大業種" value="{{ industry }}">
    <input type="text" name="sub_industry" placeholder="小業種" value="{{ sub_industry }}">

    <br>
    
    <label>活動日 (開始):</label>
    <input type="date" name="start_date" value="{{ start_date }}">
    
    <label>活動日 (終了):</label>
    <input type="date" name="end_date" value="{{ end_date }}">

    <label>営業担当者:</label>
    <select name="sales_person">
        <option value="">すべて</option>
        {% for company in companies %}
            {% for activity in company.salesactivity_set.all %}
                <option value="{{ activity.sales_person }}" {% if sales_person == activity.sales_person %}selected{% endif %}>
                    {{ activity.sales_person }}
                </option>
            {% endfor %}
        {% endfor %}
    </select>

    <label>営業結果:</label>
    <select name="result">
        <option value="">すべて</option>
        <option value="再コール" {% if result == "再コール" %}selected{% endif %}>再コール</option>
        <option value="追わない" {% if result == "追わない" %}selected{% endif %}>追わない</option>
        <option value="見込" {% if result == "見込" %}selected{% endif %}>見込</option>
        <option value="アポ成立" {% if result == "アポ成立" %}selected{% endif %}>アポ成立</option>
        <option value="受注" {% if result == "受注" %}selected{% endif %}>受注</option>
        <option value="失注" {% if result == "失注" %}selected{% endif %}>失注</option>
        <option value="不通留守" {% if result == "不通留守" %}selected{% endif %}>不通留守</option>
        <option value="担当不在" {% if result == "担当不在" %}selected{% endif %}>担当不在</option>
    </select>

    <label>次回営業予定日 (開始):</label>
    <input type="date" name="next_action_start" value="{{ next_action_start }}">
    
    <label>次回営業予定日 (終了):</label>
    <input type="date" name="next_action_end" value="{{ next_action_end }}">

    <button type="submit">検索</button>

</form>


    <table>
        <tr>
            <th>店舗名</th>
            <th>店舗電話番号</th>
            <th class="address">店舗住所</th>
            <th>法人名</th>
            <td>法人所在地</th>
            <th>活動日</th>
            <th>営業担当者</th>
            <th>営業結果</th>
            <th>次回営業予定日</th>
            <th>詳細</th>
        </tr>
        {% for company in companies %}
        <tr>
            <td>{{ company.name }}</td>
            <td>{{ company.phone }}</td>
            <td class="address">{{ company.address }}</td>
            <td>{{ company.corporation_name }}</td>
            <td>{{ company.corporation_address }}</td>

            {% with company.salesactivity_set.last as last_activity %}
            <td>{% if last_activity %}{{ last_activity.activity_date|date:"Y/m/d H:i" }}{% else %}なし{% endif %}</td>
            <td>{% if last_activity %}{{ last_activity.sales_person }}{% else %}なし{% endif %}</td>
            <td>{% if last_activity %}{{ last_activity.result }}{% else %}なし{% endif %}</td>
            <td>{% if last_activity and last_activity.next_action_date %}
                {{ last_activity.next_action_date|date:"Y/m/d H:i" }}  <!-- ✅ 時間まで表示 -->
                {% else %} なし {% endif %}
            </td>
            {% endwith %}
            
            <td><a href="{% url 'saleslist:company_detail' company.id %}">詳細を見る</a></td>

        </tr>
        {% empty %}
        <tr>
            <td colspan="9">該当する会社が見つかりませんでした。</td>
        </tr>
        {% endfor %}
    </table>
</body>
</html>
