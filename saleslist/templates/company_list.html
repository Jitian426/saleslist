<!DOCTYPE html>
<html lang="ja">
<head>
    <!-- Bootstrap 5 のCDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>会社リスト</title>
    <style>
        table {
            width: 100%;
            font-size: 12px;
            border-collapse: collapse;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border: none; /* ✅ 枠線撤廃 */
        }
        thead {
            border-bottom: 2px solid #ccc; /* ✅ ヘッダー下にグレーの線 */
        }
        tbody tr {
            border-bottom: 1px solid #e0e0e0; /* ✅ 各行の下に薄い線 */
        }
        tbody tr:nth-child(even) {
            background-color: #f9f9f9; /* ✅ 偶数行の背景色 */
        }
        tbody tr:hover {
            background-color: #f1f1f1; /* ✅ ホバー時の背景色 */
        }
        body {
            font-size: 12px;
        }
        th {
            background-color: #f2f2f2;
        }
        .address {
            max-width: 300px;  /* ✅ 店舗住所は長めに */
            word-wrap: break-word;
            white-space: normal;
        }
    </style>
</head>
<body>
    <div style="text-align: right; margin: 10px 20px; font-size: 12px;">
        {% if user.is_superuser or user.username == 'ryuji' %}
            <span style="display: inline-block; margin-right: 10px;">
                <a href="{% url 'saleslist:upload_csv' %}" class="btn btn-outline-primary btn-sm">CSVインポート</a>
                <a href="{% url 'saleslist:export_companies_csv' %}" class="btn btn-outline-success btn-sm">CSVエクスポート</a>
            </span>
        {% endif %}

        {% if user.is_authenticated %}
            <span style="display: inline-block;">
                <a href="{% url 'saleslist:dashboard' %}">ダッシュボード</a> /
                <a href="{% url 'saleslist:password_reset' %}">パスワード変更</a> /
                <form id="logout-form" action="{% url 'saleslist:logout' %}" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" style="all: unset; color: blue; cursor: pointer;">ログアウト</button>
                </form>
            </span>
        {% endif %}
    </div>

    <h2>Saleslist</h2>

    <div class="container-fluid px-4">
        <form method="GET" action="{% url 'saleslist:company_list' %}" class="mb-3">
            <div class="row g-2 align-items-end">
              <div class="col-sm-2">
                <input type="text" class="form-control form-control-sm" name="query" placeholder="店舗名" value="{{ query }}">
              </div>
              <div class="col-sm-2">
                <input type="text" class="form-control form-control-sm" name="phone" placeholder="電話番号" value="{{ phone }}">
              </div>
              <div class="col-sm-2">
                <input type="text" class="form-control form-control-sm" name="address" placeholder="住所" value="{{ address }}">
              </div>
              <div class="col-sm-2">
                <input type="text" class="form-control form-control-sm" name="corporation_name" placeholder="法人名" value="{{ corporation_name }}">
              </div>
              <div class="col-sm-2">
                <input type="text" class="form-control form-control-sm" name="industry" placeholder="大業種" value="{{ industry }}">
              </div>
              <div class="col-sm-2">
                <input type="text" class="form-control form-control-sm" name="sub_industry" placeholder="小業種" value="{{ sub_industry }}">
              </div>
          
              <!-- 改行して2段目 -->
              <div class="col-sm-2">
                <label class="form-label mb-0 small">活動日 (開始)</label>
                <input type="date" class="form-control form-control-sm" name="start_date" value="{{ start_date }}">
              </div>
              <div class="col-sm-2">
                <label class="form-label mb-0 small">活動日 (終了)</label>
                <input type="date" class="form-control form-control-sm" name="end_date" value="{{ end_date }}">
              </div>
              <div class="col-sm-2">
                <label class="form-label mb-0 small">営業担当者</label>
                <select name="sales_person" class="form-select form-select-sm">
                  <option value="">すべて</option>
                  {% for activity in sales_persons %}
                    <option value="{{ activity.sales_person }}" {% if sales_person == activity.sales_person %}selected{% endif %}>
                      {{ activity.sales_person }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-sm-2">
                <label class="form-label mb-0 small">営業結果</label>
                <select name="result" class="form-select form-select-sm">
                  <option value="">すべて</option>
                  {% for res in results %}
                    <option value="{{ res }}" {% if result == res %}selected{% endif %}>{{ res }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-sm-2">
                <label class="form-label mb-0 small">次回予定 (開始)</label>
                <input type="date" class="form-control form-control-sm" name="next_action_start" value="{{ next_action_start }}">
              </div>
              <div class="col-sm-2">
                <label class="form-label mb-0 small">次回予定 (終了)</label>
                <input type="date" class="form-control form-control-sm" name="next_action_end" value="{{ next_action_end }}">
              </div>
          
              <!-- ボタン -->
              <div class="col-sm-2">
                <button type="submit" class="btn btn-sm btn-primary w-100">検索</button>
              </div>
              <div class="col-sm-2">
                <a href="{% url 'saleslist:company_list' %}" class="btn btn-sm btn-outline-secondary w-100">すべてリセット</a>
              </div>
            </div>
        </form>
    </div>
<!-- ソート解除ボタン（右上に配置、超小型スタイル） -->
<div style="text-align: right; margin-top: -10px; margin-bottom: 10px;">
    <button type="button" class="btn btn-outline-secondary btn-sm" style="font-size: 11px; padding: 2px 6px;"
        onclick="window.location.href='?sort=id&order=asc'">
        ソート解除
    </button>
</div>
    <!-- 🔽 テーブル開始前に追加 -->
<div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
        ...
    </table>
</div>
    <table class="table table-striped table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th>
                    <a href="?sort=name&order={% if sort_column == 'name' and sort_order == 'asc' %}desc{% else %}asc{% endif %}">
                        店舗名 {% if sort_column == "name" %}{% if sort_order == "asc" %}▲{% else %}▼{% endif %}{% endif %}
                    </a>
                </th>
                <th>
                    <a href="?sort=phone&order={% if sort_column == 'phone' and sort_order == 'asc' %}desc{% else %}asc{% endif %}">
                        店舗電話番号 {% if sort_column == "phone" %}{% if sort_order == "asc" %}▲{% else %}▼{% endif %}{% endif %}
                    </a>
                </th>
                <th>
                    <a href="?sort=mobile_phone&order={% if sort_column == 'mobile_phone' and sort_order == 'asc' %}desc{% else %}asc{% endif %}">
                        携帯番号 {% if sort_column == "mobile_phone" %}{% if sort_order == "asc" %}▲{% else %}▼{% endif %}{% endif %}
                    </a>
                </th>
                <th class="address">
                    <a href="?sort=address&order={% if sort_column == 'address' and sort_order == 'asc' %}desc{% else %}asc{% endif %}">
                        店舗住所 {% if sort_column == "address" %}{% if sort_order == "asc" %}▲{% else %}▼{% endif %}{% endif %}
                    </a>
                </th>
                <th>
                    <a href="?sort=corporation_name&order={% if sort_column == 'corporation_name' and sort_order == 'asc' %}desc{% else %}asc{% endif %}">
                        法人名 {% if sort_column == "corporation_name" %}{% if sort_order == "asc" %}▲{% else %}▼{% endif %}{% endif %}
                    </a>
                </th>
                <th>
                    <a href="?sort=established_date&order={% if sort_column == 'established_date' and sort_order == 'asc' %}desc{% else %}asc{% endif %}">
                        開業日 {% if sort_column == "established_date" %}{% if sort_order == "asc" %}▲{% else %}▼{% endif %}{% endif %}
                    </a>
                </th>
                <th>
                    <a href="?sort=license_number&order={% if sort_column == 'license_number' and sort_order == 'asc' %}desc{% else %}asc{% endif %}">
                        許可番号 {% if sort_column == "license_number" %}{% if sort_order == "asc" %}▲{% else %}▼{% endif %}{% endif %}
                    </a>
                </th>
                <th>
                    <a href="?sort=activity_date&order={% if sort_column == 'activity_date' and sort_order == 'asc' %}desc{% else %}asc{% endif %}">
                        活動日 {% if sort_column == "activity_date" %}{% if sort_order == "asc" %}▲{% else %}▼{% endif %}{% endif %}
                    </a>
                </th>
                <th>
                    <a href="?sort=sales_person&order={% if sort_column == 'sales_person' and sort_order == 'asc' %}desc{% else %}asc{% endif %}">
                        営業担当者 {% if sort_column == "sales_person" %}{% if sort_order == "asc" %}▲{% else %}▼{% endif %}{% endif %}
                    </a>
                </th>
                <th>
                    <a href="?sort=result&order={% if sort_column == 'result' and sort_order == 'asc' %}desc{% else %}asc{% endif %}">
                        営業結果 {% if sort_column == "result" %}{% if sort_order == "asc" %}▲{% else %}▼{% endif %}{% endif %}
                    </a>
                </th>
                <th>
                    <a href="?sort=next_action_date&order={% if sort_column == 'next_action_date' and sort_order == 'asc' %}desc{% else %}asc{% endif %}">
                        次回営業予定日 {% if sort_column == "next_action_date" %}{% if sort_order == "asc" %}▲{% else %}▼{% endif %}{% endif %}
                    </a>
                </th>
            </tr>
        </thead>
        <tbody>
        {% for company in companies %}
        
            <tr>
                <td><a href="{% url 'saleslist:company_detail' company.id %}">{{ company.name }}</a></td>
                <td>{{ company.phone }}</td>
                <td>{{ company.mobile_phone }}</td>
                <td class="address">{{ company.address }}</td>
                <td>{{ company.corporation_name }}</td>
                <td>{{ company.established_date|date:"Y/m/d" }}</td>
                <td>{{ company.license_number }}</td>
    
                {% with company.salesactivity_set.last as last_activity %}
                <td>{% if last_activity %}{{ last_activity.activity_date|date:"Y/m/d H:i" }}{% else %}なし{% endif %}</td>
                <td>{% if last_activity %}{{ last_activity.sales_person }}{% else %}なし{% endif %}</td>
                <td>{% if last_activity %}{{ last_activity.result }}{% else %}なし{% endif %}</td>
                <td>{% if last_activity and last_activity.next_action_date %}
                    {{ last_activity.next_action_date|date:"Y/m/d H:i" }}  <!-- ✅ 時間まで表示 -->
                    {% else %} なし {% endif %}
                </td>
                {% endwith %}
            </tr>
            
        {% empty %}
            <tr>
                <td colspan="9">該当する会社が見つかりませんでした。</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>


</body>
</html>
