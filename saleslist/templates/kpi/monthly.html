{% extends "base.html" %}
{% load static %}
{% block title %}æœˆæ¬¡KPIï¼ˆæ‹…å½“è€…åˆ¥ï¼‰{% endblock %}

{% block content %}
<div class="container-fluid py-3">
  <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
    <h3 class="m-0">æœˆæ¬¡KPIï¼ˆæ‹…å½“è€…åˆ¥ï¼‰</h3>
    <form class="d-flex" method="get">
      <input type="month" name="ym" class="form-control me-2"
             value="{{ year }}-{% if month < 10 %}0{% endif %}{{ month }}">
      <button class="btn btn-primary" type="submit">è¡¨ç¤º</button>
    </form>
  </div>
  
  <a href="{% url 'saleslist:daily_kpi' %}" class="btn btn-outline-secondary btn-sm">
    ğŸ”™ æ—¥æ¬¡KPIã¸æˆ»ã‚‹
  </a>

  <div class="card shadow-sm mb-3">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle m-0">
          <thead class="table-light">
            <tr>
              <th>å–¶æ¥­æ‹…å½“è€…</th>
              <th class="text-end">ã‚³ãƒ¼ãƒ«æ•°</th>
              <th class="text-end">ãƒ’ãƒƒãƒˆæ•°</th>
              <th class="text-end">ãƒ’ãƒƒãƒˆç‡</th>
              <th class="text-end">æ±ºè£è€…ã‚³ãƒ³ã‚¿ã‚¯ãƒˆæ•°</th>
              <th class="text-end">æ±ºè£è€…ç‡</th>
              <th class="text-end">è¦‹è¾¼æ•°</th>
              <th class="text-end">è¦‹è¾¼ç‡</th>
              <th class="text-end">ã‚¢ãƒæˆç«‹æ•°</th>
              <th class="text-end">ã‚¢ãƒç‡</th>
              <th class="text-end">å—æ³¨æ•°</th>
              <th class="text-end">å—æ³¨ç‡</th>
            </tr>
          </thead>
          <tbody>
            {% for r in rows %}
            <tr>
              <td>{{ r.name }}</td>
              <td class="text-end">{{ r.calls }}</td>
              <td class="text-end">{{ r.hits }}</td>
              <td class="text-end">{{ r.hit_rate|floatformat:1 }}%</td>
              <td class="text-end">{{ r.decisions }}</td>
              <td class="text-end">{{ r.decision_rate|floatformat:1 }}%</td>
              <td class="text-end">{{ r.mikomi }}</td>
              <td class="text-end">{{ r.mikomi_rate|floatformat:1 }}%</td>
              <td class="text-end">{{ r.apo }}</td>
              <td class="text-end">{{ r.apo_rate|floatformat:1 }}%</td>
              <td class="text-end">{{ r.ju }}</td>
              <td class="text-end">{{ r.ju_rate|floatformat:1 }}%</td>
            </tr>
            {% empty %}
            <tr><td colspan="10" class="text-center text-muted py-4">å¯¾è±¡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>
            {% endfor %}
          </tbody>
          <tfoot class="table-secondary">
            <tr>
              <th>åˆè¨ˆ</th>
              <th class="text-end">{{ totals.calls }}</th>
              <th class="text-end">{{ totals.hits }}</th>
              <th class="text-end">{{ totals.hit_rate|floatformat:1 }}%</th>
              <th class="text-end">{{ totals.decisions }}</th>
              <th class="text-end">{{ totals.decision_rate|floatformat:1 }}%</th>
              <th class="text-end">{{ totals.mikomi }}</th>
              <th class="text-end">{{ totals.mikomi_rate|floatformat:1 }}%</th>
              <th class="text-end">{{ totals.apo }}</th>
              <th class="text-end">{{ totals.apo_rate|floatformat:1 }}%</th>
              <th class="text-end">{{ totals.ju }}</th>
              <th class="text-end">{{ totals.ju_rate|floatformat:1 }}%</th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

  <!-- ã‚°ãƒ©ãƒ• -->
  <div class="row g-3">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <h6 class="mb-3">æ‹…å½“è€…åˆ¥ãƒ»æœˆæ¬¡KPIï¼ˆã‚¹ã‚¿ãƒƒã‚¯æ£’ï¼‰</h6>
          <canvas id="kpiBar"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h6 class="mb-3">ã‚³ãƒ¼ãƒ«æ•°ã®æ§‹æˆæ¯”ï¼ˆå††ï¼‰</h6>
          <canvas id="callsPie"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="text-muted small mt-3">é›†è¨ˆæœŸé–“ï¼š{{ start|date:"Yå¹´næœˆjæ—¥" }} ã€œ {{ end|date:"Yå¹´næœˆjæ—¥" }}</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const labels = {{ labels|safe }};
  // ã“ã“ã‚’ views.py ã® chart_data ã«åˆã‚ã›ã‚‹
  const dataNCOW  = {{ chart_data.nc_owanai|safe }};  // ä¸é€šç•™å®ˆ + è¿½ã‚ãªã„ï¼ˆã‚°ãƒ¬ãƒ¼æ£’ï¼‰
  const dataHits  = {{ chart_data.hits|safe }};
  const dataDec   = {{ chart_data.decisions|safe }};
  const dataMikom = {{ chart_data.mikomi|safe }};
  const dataApo   = {{ chart_data.apo|safe }};

  // ã‚¹ã‚¿ãƒƒã‚¯æ£’ï¼šå…ˆé ­ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ã€Œä¸é€šç•™å®ˆ+è¿½ã‚ãªã„ï¼ˆã‚°ãƒ¬ãƒ¼ï¼‰ã€ã«å¤‰æ›´
  // æ—¢å­˜ã® datasets ã‚’ã“ã®ç‰ˆã«ç½®ãæ›ãˆ
  new Chart(document.getElementById('kpiBar'), {
    type: 'bar',
    data: {
      labels,
      datasets: [
        // â‘  ä¸é€šç•™å®ˆï¼‹è¿½ã‚ãªã„ï¼ˆæŒ‡å®šã©ãŠã‚Šã‚°ãƒ¬ãƒ¼ï¼‰
        {label:'ä¸é€šç•™å®ˆ+è¿½ã‚ãªã„', data:dataNCOW, stack:'s1',
         backgroundColor:'#adb5bd', borderColor:'#adb5bd', borderWidth:1},

        // â‘¡ ä»¥é™ã¯ã‚«ãƒ©ãƒ¼å›ºå®šï¼ˆä»¥å‰ã®è‡ªå‹•é…è‰²ã®ä»£ã‚ã‚Šã«æ˜ç¢ºãªè‰²ã‚’ä»˜ä¸ï¼‰
        {label:'ãƒ’ãƒƒãƒˆ',   data:dataHits,  stack:'s1',
         backgroundColor:'rgba(54,162,235,0.6)', borderColor:'rgb(54,162,235)', borderWidth:1},
        {label:'æ±ºè£è€…',   data:dataDec,   stack:'s1',
         backgroundColor:'rgba(255,159,64,0.6)', borderColor:'rgb(255,159,64)', borderWidth:1},
        {label:'è¦‹è¾¼',     data:dataMikom, stack:'s1',
         backgroundColor:'rgba(255,99,132,0.6)', borderColor:'rgb(255,99,132)', borderWidth:1},
        {label:'ã‚¢ãƒæˆç«‹', data:dataApo,   stack:'s1',
         backgroundColor:'rgba(75,192,192,0.6)', borderColor:'rgb(75,192,192)', borderWidth:1},
      ]
    },
    options: {
      responsive: true,
      interaction: {mode: 'index', intersect: false},
      plugins: {legend: {position: 'bottom'}},
      scales: {x: {stacked: true}, y: {stacked: true, beginAtZero: true}}
    }
  });
  
  // ä¸Šéƒ¨ã®ãƒ‡ãƒ¼ã‚¿å—ã‘å–ã‚Š
  const dataCalls = {{ chart_data.calls|safe }};

  // å††ã‚°ãƒ©ãƒ•ï¼šã‚³ãƒ¼ãƒ«æ•°ã®æ§‹æˆæ¯”
  new Chart(document.getElementById('callsPie'), {
    type: 'pie',
    data: {
      labels,
      datasets: [{
        data: dataCalls,
        backgroundColor: [
          'rgb(54,162,235)',  // é’
          'rgb(255,99,132)',  // èµ¤
          'rgb(255,205,86)',  // é»„
          'rgb(75,192,192)',  // ç·‘
          'rgb(153,102,255)', // ç´«
          'rgb(255,159,64)',  // ã‚ªãƒ¬ãƒ³ã‚¸
        ],
        borderWidth: 1
      }]
    },
  options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
  });

</script>


{% endblock %}


