{% extends "base.html" %}
{% load static %}
{% block title %}月次KPI（担当者別）{% endblock %}

{% block content %}
<div class="container-fluid py-3">
  <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
    <h3 class="m-0">月次KPI（担当者別）</h3>
    <form class="d-flex" method="get">
      <input type="month" name="ym" class="form-control me-2"
             value="{{ year }}-{% if month < 10 %}0{% endif %}{{ month }}">
      <button class="btn btn-primary" type="submit">表示</button>
    </form>
  </div>

  <div class="card shadow-sm mb-3">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle m-0">
          <thead class="table-light">
            <tr>
              <th>営業担当者</th>
              <th class="text-end">コール数</th>
              <th class="text-end">ヒット数</th>
              <th class="text-end">ヒット率</th>
              <th class="text-end">決裁者コンタクト数</th>
              <th class="text-end">決裁者率</th>
              <th class="text-end">見込数</th>
              <th class="text-end">見込率</th>
              <th class="text-end">アポ成立数</th>
              <th class="text-end">アポ率</th>
              <th class="text-end">受注数</th>
              <th class="text-end">受注率</th>
            </tr>
          </thead>
          <tbody>
            {% for r in rows %}
            <tr>
              <td>{{ r.name }}</td>
              <td class="text-end">{{ r.calls }}</td>
              <td class="text-end">{{ r.hits }}</td>
              <td class="text-end">{{ r.hit_rate|floatformat:1 }}%</td>
              <td class="text-end">{{ r.decisions }}</td>
              <td class="text-end">{{ r.decision_rate|floatformat:1 }}%</td>
              <td class="text-end">{{ r.mikomi }}</td>
              <td class="text-end">{{ r.mikomi_rate|floatformat:1 }}%</td>
              <td class="text-end">{{ r.apo }}</td>
              <td class="text-end">{{ r.apo_rate|floatformat:1 }}%</td>
              <td class="text-end">{{ r.ju }}</td>
              <td class="text-end">{{ r.ju_rate|floatformat:1 }}%</td>
            </tr>
            {% empty %}
            <tr><td colspan="10" class="text-center text-muted py-4">対象データがありません</td></tr>
            {% endfor %}
          </tbody>
          <tfoot class="table-secondary">
            <tr>
              <th>合計</th>
              <th class="text-end">{{ totals.calls }}</th>
              <th class="text-end">{{ totals.hits }}</th>
              <th class="text-end">{{ totals.hit_rate|floatformat:1 }}%</th>
              <th class="text-end">{{ totals.decisions }}</th>
              <th class="text-end">{{ totals.decision_rate|floatformat:1 }}%</th>
              <th class="text-end">{{ totals.mikomi }}</th>
              <th class="text-end">{{ totals.mikomi_rate|floatformat:1 }}%</th>
              <th class="text-end">{{ totals.apo }}</th>
              <th class="text-end">{{ totals.apo_rate|floatformat:1 }}%</th>
              <th class="text-end">{{ totals.ju }}</th>
              <th class="text-end">{{ totals.ju_rate|floatformat:1 }}%</th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

  <!-- グラフ -->
  <div class="row g-3">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <h6 class="mb-3">担当者別・月次KPI（スタック棒）</h6>
          <canvas id="kpiBar"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h6 class="mb-3">コール数の構成比（円）</h6>
          <canvas id="callsPie"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="text-muted small mt-3">集計期間：{{ start|date:"Y年n月j日" }} 〜 {{ end|date:"Y年n月j日" }}</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const labels = {{ labels|safe }};
  // ここを views.py の chart_data に合わせる
  const dataNCOW  = {{ chart_data.nc_owanai|safe }};  // 不通留守 + 追わない（グレー棒）
  const dataHits  = {{ chart_data.hits|safe }};
  const dataDec   = {{ chart_data.decisions|safe }};
  const dataMikom = {{ chart_data.mikomi|safe }};
  const dataApo   = {{ chart_data.apo|safe }};

  // スタック棒：先頭データセットを「不通留守+追わない（グレー）」に変更
  // 既存の datasets をこの版に置き換え
  new Chart(document.getElementById('kpiBar'), {
    type: 'bar',
    data: {
      labels,
      datasets: [
        // ① 不通留守＋追わない（指定どおりグレー）
        {label:'不通留守+追わない', data:dataNCOW, stack:'s1',
         backgroundColor:'#adb5bd', borderColor:'#adb5bd', borderWidth:1},

        // ② 以降はカラー固定（以前の自動配色の代わりに明確な色を付与）
        {label:'ヒット',   data:dataHits,  stack:'s1',
         backgroundColor:'rgba(54,162,235,0.6)', borderColor:'rgb(54,162,235)', borderWidth:1},
        {label:'決裁者',   data:dataDec,   stack:'s1',
         backgroundColor:'rgba(255,159,64,0.6)', borderColor:'rgb(255,159,64)', borderWidth:1},
        {label:'見込',     data:dataMikom, stack:'s1',
         backgroundColor:'rgba(255,99,132,0.6)', borderColor:'rgb(255,99,132)', borderWidth:1},
        {label:'アポ成立', data:dataApo,   stack:'s1',
         backgroundColor:'rgba(75,192,192,0.6)', borderColor:'rgb(75,192,192)', borderWidth:1},
      ]
    },
    options: {
      responsive: true,
      interaction: {mode: 'index', intersect: false},
      plugins: {legend: {position: 'bottom'}},
      scales: {x: {stacked: true}, y: {stacked: true, beginAtZero: true}}
    }
  });
  
  // 上部のデータ受け取り
  const dataCalls = {{ chart_data.calls|safe }};

  // 円グラフ：コール数の構成比
  new Chart(document.getElementById('callsPie'), {
    type: 'pie',
    data: {
      labels,
      datasets: [{
        data: dataCalls,
        backgroundColor: [
          'rgb(54,162,235)',  // 青
          'rgb(255,99,132)',  // 赤
          'rgb(255,205,86)',  // 黄
          'rgb(75,192,192)',  // 緑
          'rgb(153,102,255)', // 紫
          'rgb(255,159,64)',  // オレンジ
        ],
        borderWidth: 1
      }]
    },
  options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
  });

</script>


{% endblock %}


